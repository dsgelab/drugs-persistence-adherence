rm(list=ls())

library(R.utils)
library(data.table)
library(dplyr)

# Combine vnr mapping files
vnr <- fread('/home/cordioli/drugs/vnr_from_fimea_6_4_2020.csv')
vnr2 <- fread('/home/cordioli/drugs/data/vnr_mapping.tsv')

str(vnr)
# $ ATCKOODI       : chr  "J05AR02" "J05AR02" "J05AR02" "N02AC04" ...
# $ MYYNTILUPANRO  : int  33010 37463 33761 1886 1886 1886 5297 5297 31671 32908 ...
# $ PAATOSPVM      : chr  "13.10.2016" "25.10.2019" "08.07.2016" "07.07.1965" ...
# $ PAATTYMISPVM   : chr  "13.10.2021" "25.10.2024" "08.07.2021" "05.02.2010" ...
# $ LAAKENIMI      : chr  "ABACAVIR/LAMIVUDIN MYLAN" "ABACAVIR/LAMIVUDINE SANDOZ" "ABACAVIR/LAMIVUDINE STADA" "ABALGIN" ...
# $ VAHVUUS        : chr  "600 mg / 300 mg" "600 mg / 300 mg" "600 mg / 300 mg" "65 mg" ...
# $ LAAKEMUOTONIMI : chr  "tabletti, kalvop\xe4\xe4llysteinen" "tabletti, kalvop\xe4\xe4llysteinen" "tabletti, kalvop\xe4\xe4llysteinen" "kapseli, kova" ...
# $ PROSESSINIMI   : chr  "Hajautettu" "Kansallinen" "Hajautettu" "Kansallinen" ...
# $ TILANIMI       : chr  "Myyntilupa my\xf6nnetty" "Myyntilupa my\xf6nnetty" "Myyntilupa my\xf6nnetty" "Myyntilupa peruuntunut hakijan toimesta" ...
# $ HALTIJANNIMI   : chr  "MYLAN AB" "ORIFARM" "STADA ARZNEIMITTEL A" "ALTERNOVA A/S" ...
# $ PAKKAUSKOKO    : chr  "30" "30" "30" "50" ...
# $ NIMI           : chr  "L\xe4pipainopakkaus" "L\xe4pipainopakkaus" "L\xe4pipainopakkaus" "Tablettipurkki" ...
# $ KAUPAN         : int  1 0 1 0 0 0 0 0 1 1 ...
# $ VNRNRO         : int  468375 516851 444643 199984 496158 199976 199935 119917 451991 138421 ...
# $ KAUPPAANTULOPVM: chr  "15.01.2018" "01.12.2019" "01.03.2019" "" ...
# $ KAUPASTAPOISPVM: chr  "" "" "" "31.05.2002" ...

str(vnr2)
# $ vnr        : int  3 4 5 11 18 19 51 52 54 55 ...
# $ ATC        : chr  "J01DB05" "J01DB05" "N05AX08" "J01DB05" ...
# $ valmiste   : chr  "CEFADROXIL GENERICS" "CEFADROXIL GENERICS" "RISPERDAL" "CEFADROXIL GENERICS" ...
# $ vahvuus    : chr  "100MG/ML" "500 MG" "0.5 mg" "100MG/ML" ...
# $ vahvuus_num: num  1e+02 5e+02 5e-01 1e+02 NA 4e+02 1e+01 4e+02 4e+03 6e+04 ...
# $ pkoko      : chr  "100ML (AQ 50G)" "14" "20" "60ML (AQ 30G)" ...
# $ pkoko_num  : num  100 14 20 60 1 10 100 100 6 1 ...

# # #
# SELECT SAME COLUMNS OF THE OLD FILE
# FILTER ONLY VNRs NOT PRESENT IN THE OLD FILE
vnr <- vnr %>%
  select(VNRNRO, ATCKOODI, LAAKENIMI, VAHVUUS, PAKKAUSKOKO) %>%
  filter(!VNRNRO %in% vnr2$vnr)
colnames(vnr) <- c('vnr', 'ATC', 'valmiste', 'vahvuus', 'pkoko')

#TODO: compute vahvuus_num and pkoko_num columns (done for statins only for now beacuse is easier, multiple measures, units, +, x to manage)
v <- vnr$vahvuus[grepl('^C10AA', vnr$ATC)]
v[grepl('mikrog$', v)] <- 0.001*as.numeric(gsub("([0-9]+).*$", "\\1", v[grepl('mikrog$', v)]))
v[grepl('mg$', v)] <- as.numeric(gsub("([0-9]+).*$", "\\1", v[grepl('mg$', v)]))
vnr$vahvuus_num[grepl('^C10AA', vnr$ATC)] <- v
vnr$vahvuus_num <- as.numeric(vnr$vahvuus_num)

p <- vnr$pkoko[grepl('^C10AA', vnr$ATC)]
vnr$pkoko_num[grepl('^C10AA', vnr$ATC)] <- as.numeric(p)

# Reorder columns and unite
vnr <- vnr %>%
  select(vnr, ATC, valmiste, vahvuus, vahvuus_num, pkoko, pkoko_num) %>%
  union(vnr2)

fwrite(vnr, '/home/cordioli/drugs/data/vnr_mapping_6_5.tsv', sep = '\t', quote = F)
